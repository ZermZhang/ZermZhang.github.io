---
title: 通过expect进行自动ssh登陆
tags: ['ssh','expect','linux']
date: 2022-05-10
categories: ['linux']
---

> 本文主要是为了解决通过跳板机/堡垒机登陆时，在完成ssh链接之后依旧有一些操作需要处理的问题。
> 如何配置通过SSH配置文件创建SSH链接，可以参考[本文](https://zermzhang.github.io/2022/05/10/linux/ssh%E7%99%BB%E9%99%86%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE/)

# 1. 堡垒机
堡垒机，即在一个特定的网络环境下，为了保证网络和数据不受来自外部和内部用户的入侵和破坏，而运用各种技术手段监控、记录运维远远对网络内部的服务器、网络设备、安全设备、数据库等设备的操作行为，以便集中报警、及时处理和审计定责。
上面这一段官话时百度百科对堡垒机的定义。
但是我们这种非运维人员对堡垒机的印象可能就是简单的在服务器之间加了一层，增加了登陆服务器的成本而已。当然，我们这里不讨论堡垒机的具体作用，只是为了解决如何在terminal下通过expect脚本自动跳过堡垒机上的相关操作。
![堡垒机例子](https://s2.loli.net/2022/05/10/eH1ZdGV4UbPf5Lv.png)
如上图，是常见的堡垒机登陆的页面，expect脚本主要是为了跳过每次登陆过程中的选择过程。

# 2. expect脚本
expect是一个自动化交互的工具，主要是在执行命令时，可以通过交互的方式根据返回输入指定的字符串。
整体流程主要由4个部分组成：
1. spawn：启动指定的进程
2. expect：检测是否获取到指定的关键字
3. send：向进程发送指定字符
4. 执行完成退出

## 2.1 常用命令总结
|命令|说明|
|--|--|
|spawn|交互程序开始，后面跟指定进程的命令|
|expect|获取匹配信息，成功话，执行后续命令|
|send|发送指定字符串信息|
|exp_continue|在expect中需要多次匹配的时候，表示中间过程|
|send_user|打印输出，相当于echo|
|exit|退出expect脚本|
|eof|expect执行结束|
|interact|执行完成后保持交互状态，可以手动操作。如果没有这一句执行结束后会直接退出|
|set|定义变量|
|puts|输出变量|
|set timeout|设置超时时间|

## 2.2 脚本例子
```shell
#!/usr/bin/expect
spawn ssh work-ali
expect {
    "请选择目标资产：" {send "${需要登陆的机器编号}\n"; exp_continue}
    "*\$ " {send "${登陆到指定机器后需要执行的命令}\n"}
}
interact
```